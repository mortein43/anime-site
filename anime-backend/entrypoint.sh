#!/bin/sh

echo "‚ö† –ß–µ–∫–∞—î–º–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."

until pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" > /dev/null 2>&1; do
  echo "–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —á–µ–∫–∞—î–º–æ..."
  sleep 2
done

echo "‚úî –ë–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–∞!"

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—ó
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ php artisan migrate"
php artisan migrate || true

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å—ñ–¥–µ—Ä–∏ —Ç–∞ —á–∏ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –ø–æ—Ä–æ–∂–Ω—è
if [ "$RUN_SEEDER" = "true" ]; then
  echo "–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –ø–æ—Ä–æ–∂–Ω—è –¥–ª—è —Å—ñ–¥–µ—Ä—ñ–≤..."
  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î —Ç–∞–±–ª–∏—Ü—è users —ñ —á–∏ –≤–æ–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è
  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ psql –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑–∞–ø–∏—Å—ñ–≤ —É —Ç–∞–±–ª–∏—Ü—ñ users
  # –Ø–∫—â–æ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î, —Ç–æ —Ç–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è, —ñ –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å—ñ–¥–µ—Ä–∏
  if ! psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$DB_DATABASE" -tAc "SELECT 1 FROM users LIMIT 1" | grep -q 1; then
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ php artisan db:seed"
    php artisan db:seed || true
  else
    echo "–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –Ω–µ –ø–æ—Ä–æ–∂–Ω—è, —Å—ñ–¥–µ—Ä–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è."
  fi
else
  echo "–ó–∞–ø—É—Å–∫ —Å—ñ–¥–µ—Ä—ñ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ (RUN_SEEDER –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ 'true')."
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ php-fpm
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ php-fpm"
exec php-fpm
